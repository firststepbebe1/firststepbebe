<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin · First Step Bebe</title>
<style>
body{font-family:Arial, sans-serif; margin:0; background:#fffaf6; color:#463d3d}
.wrap{max-width:1000px; margin:40px auto; background:#fff; padding:20px; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.08)}
h1{margin:0 0 16px}
.grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
input, textarea{width:100%; padding:10px; border:1px solid #e6e1ff; border-radius:10px; font-family:inherit}
table{width:100%; border-collapse:collapse; margin-top:16px; background:#fff}
th,td{padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:14px}
.btn{border:none; background:#6c63ff; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700}
.btn.alt{background:#f3eefc; color:#463d3d}
.badge{display:inline-block; background:#f3eefc; padding:4px 8px; border-radius:999px; font-size:12px}
.top{display:flex; justify-content:space-between; align-items:center; gap:12px}
.note{font-size:13px; color:#8c7f7f}
.lock{display:flex; gap:8px; align-items:center; margin-bottom:16px}
</style>
</head>
<body>
<script>try{document.write('<script src="config.js"><\/script>')}catch(e){}</script>
<div class="wrap">
  <div class="top">
    <h1>Admin · First Step Bebe</h1>
    <span class="badge">demo localStorage</span>
  </div>

  <div class="lock">
    <label>Parolă: <input id="pass" type="password" placeholder="admin123"></label>
    <button class="btn alt" id="loginBtn">Intră</button>
    <span class="note">* simplu, doar pentru test local</span>
  </div>

  <div id="panel" style="display:none">
    <h3>Adaugă / editează produs</h3>
    <div class="grid">
      <label>Nume<br><input id="fName" type="text"></label>
      <label>Categorie (ex: body, costumas, compleu, pijama, accesorii)<br><input id="fCategory" type="text"></label>
      <label>Preț (lei)<br><input id="fPrice" type="number" step="0.01"></label>
      <label>Set<br><input id="fPack" type="text" placeholder="10 bucăți pe set"></label>
      <label>Mărimi (separate cu virgulă)<br><input id="fSizes" type="text" placeholder="0-3, 3-6, 6-9"></label>
      <label>Culori (separate cu virgulă)<br><input id="fColors" type="text" placeholder="alb, roz, bleu"></label>
      <label>Imagine URL (ex: assets/body.jpg)<br><input id="fImage" type="text" placeholder="assets/… sau Data URL"></label>
      <label>Încărcare imagine (opțional)<br><input id="fImageFile" type="file" accept="image/*"></label>
      <label>Stoc (buc)<br><input id="fStock" type="number"></label>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <button class="btn" id="saveBtn">Salvează</button>
      <button class="btn alt" id="newBtn">Curăță</button>
      <button class="btn alt" id="clearImageBtn">Șterge imagine</button>
      <div style="display:flex; align-items:center; gap:8px">
        <span class="note">Previzualizare:</span>
        <img id="imgPreview" src="" alt="previzualizare" style="width:72px; height:72px; object-fit:cover; border-radius:10px; background:#f4f0ec; display:none">
      </div>
    </div>

    <h3 style="margin-top:24px">Utilitare produse</h3>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <button class="btn" id="exportBtn">Export JSON</button>
      <label class="btn alt" for="importFile" style="cursor:pointer">Import JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>

    <h3 style="margin-top:24px">Produse existente</h3>
    <table id="tbl">
      <thead><tr><th>#</th><th>Nume</th><th>Categorie</th><th>Preț</th><th>Stoc</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const PASS = 'admin123';
const LS_PRODUCTS='fsb_products';
// Supabase config (din config.js dacă există)
const CFG = (window.APP_CONFIG||{});
const SUPABASE_URL = CFG.SUPABASE_URL || '';
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY || '';
const SUPABASE_SERVICE_SCHEMA = { table: 'products', bucket: (CFG.SUPABASE_BUCKET || 'product-images') };
let supa = null;
let UPLOADED_IMAGE_DATA = null;

const $=q=>document.querySelector(q);

document.getElementById('loginBtn').onclick=()=>{
  if(document.getElementById('pass').value===PASS){ document.getElementById('panel').style.display='block'; } else alert('Parolă greșită');
};

let PRODUCTS = JSON.parse(localStorage.getItem(LS_PRODUCTS) || '[]');

function render(){
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  PRODUCTS.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${p.category||''}</td><td>${p.price||0}</td><td>${p.stock||0}</td>
    <td>
      <button data-i="${i}" class="edit">Editează</button>
      <button data-i="${i}" class="del">Șterge</button>
    </td>`;
    tb.appendChild(tr);
  });
}
render();

document.getElementById('tbl').onclick=(e)=>{
  if(e.target.className==='edit'){
    const i=+e.target.dataset.i, p=PRODUCTS[i];
    document.getElementById('fName').value=p.name||'';
    document.getElementById('fCategory').value=p.category||'';
    document.getElementById('fPrice').value=p.price||'';
    document.getElementById('fPack').value=p.pack||'10 bucăți pe set';
    document.getElementById('fSizes').value=(p.sizes||[]).join(', ');
    document.getElementById('fColors').value=(p.colors||[]).join(', ');
    document.getElementById('fImage').value=p.image||'';
    document.getElementById('fStock').value=p.stock||0;
    document.getElementById('saveBtn').dataset.edit=i;
    // preview imagine
    const prev=document.getElementById('imgPreview');
    if(p.image){ prev.src=p.image; prev.style.display='inline-block'; } else { prev.removeAttribute('src'); prev.style.display='none'; }
    UPLOADED_IMAGE_DATA = null;
    window.scrollTo({top:0,behavior:'smooth'});
  }
  if(e.target.className==='del'){
    const i=+e.target.dataset.i;
    if(confirm('Sigur ștergi produsul?')){
      PRODUCTS.splice(i,1); localStorage.setItem(LS_PRODUCTS, JSON.stringify(PRODUCTS)); render();
    }
  }
};

document.getElementById('newBtn').onclick=()=>{
  ['fName','fCategory','fPrice','fPack','fSizes','fColors','fImage','fStock'].forEach(id=>document.getElementById(id).value='');
  delete document.getElementById('saveBtn').dataset.edit;
  const prev=document.getElementById('imgPreview'); prev.removeAttribute('src'); prev.style.display='none';
  UPLOADED_IMAGE_DATA = null;
};

document.getElementById('saveBtn').onclick=()=>{
  const payload = {
    name: document.getElementById('fName').value.trim(),
    category: (document.getElementById('fCategory').value||'').trim().toLowerCase(),
    price: parseFloat(document.getElementById('fPrice').value||'0'),
    pack: document.getElementById('fPack').value.trim() || '10 bucăți pe set',
    sizes: (document.getElementById('fSizes').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    colors: (document.getElementById('fColors').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    image: (UPLOADED_IMAGE_DATA || document.getElementById('fImage').value.trim()),
    stock: parseInt(document.getElementById('fStock').value||'0',10)
  };
  const idx = document.getElementById('saveBtn').dataset.edit;
  if(idx!==undefined){ PRODUCTS[+idx]=payload; } else { PRODUCTS.push(payload); }
  localStorage.setItem(LS_PRODUCTS, JSON.stringify(PRODUCTS));
  render();
  alert('Salvat local!');
};

// Încărcare imagine -> dataURL + preview
document.getElementById('fImageFile').addEventListener('change', (ev)=>{
  const file = ev.target.files && ev.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    UPLOADED_IMAGE_DATA = reader.result;
    const prev=document.getElementById('imgPreview'); prev.src=UPLOADED_IMAGE_DATA; prev.style.display='inline-block';
    document.getElementById('fImage').value='';
  };
  reader.readAsDataURL(file);
});

// Ștergere imagine din formular
document.getElementById('clearImageBtn').onclick=()=>{
  document.getElementById('fImage').value='';
  UPLOADED_IMAGE_DATA = null;
  const prev=document.getElementById('imgPreview'); prev.removeAttribute('src'); prev.style.display='none';
};

// Export produse
document.getElementById('exportBtn').onclick=()=>{
  const data = JSON.stringify(PRODUCTS, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='produse.json'; a.click();
  URL.revokeObjectURL(url);
};

// Import produse
document.getElementById('importFile').addEventListener('change', async (ev)=>{
  const file = ev.target.files && ev.target.files[0]; if(!file) return;
  try{
    const text = await file.text();
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('Format invalid');
    PRODUCTS = arr;
    localStorage.setItem(LS_PRODUCTS, JSON.stringify(PRODUCTS));
    render();
    alert('Import reușit!');
  }catch(err){ alert('Eroare la import: '+err.message); }
  ev.target.value='';
});

// ===== Supabase init + CRUD (opțional, dacă setezi cheile)
async function loadSupabase(){
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY) return null;
  if(window.supabase) return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  await new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'; s.onload=resolve; s.onerror=reject; document.head.appendChild(s) });
  return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}

(async function init(){
  supa = await loadSupabase();
  if(!supa){ console.log('Supabase neconfigurat – admin funcționează local.'); return; }
  // Exemplu: încărcare produse din DB
  try{
    const { data, error } = await supa.from(SUPABASE_SERVICE_SCHEMA.table).select('*').order('created_at',{ascending:false});
    if(!error && Array.isArray(data)){
      PRODUCTS = data.map((p,i)=>({
        id: p.id || (i+1), name:p.name||'', category:(p.category||'').toLowerCase(), price:Number(p.price)||0, pack:p.pack||'10 bucăți pe set',
        sizes:p.sizes||[], colors:p.colors||[], image:p.image_url||'', stock:Number(p.stock)||0
      }));
      localStorage.setItem(LS_PRODUCTS, JSON.stringify(PRODUCTS));
      render();
    }
  }catch(err){ console.warn(err); }

  // Suprascrie butonul de salvare pentru a scrie în DB
  const originalSave = document.getElementById('saveBtn').onclick;
  document.getElementById('saveBtn').onclick = async ()=>{
    const payload = {
      name: document.getElementById('fName').value.trim(),
      category: (document.getElementById('fCategory').value||'').trim().toLowerCase(),
      price: parseFloat(document.getElementById('fPrice').value||'0'),
      pack: document.getElementById('fPack').value.trim() || '10 bucăți pe set',
      sizes: (document.getElementById('fSizes').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      colors: (document.getElementById('fColors').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      image_url: (UPLOADED_IMAGE_DATA || document.getElementById('fImage').value.trim()),
      stock: parseInt(document.getElementById('fStock').value||'0',10)
    };
    const idx = document.getElementById('saveBtn').dataset.edit;
    try{
      let resp;
      if(idx!==undefined && PRODUCTS[+idx]?.id){
        resp = await supa.from(SUPABASE_SERVICE_SCHEMA.table).update(payload).eq('id', PRODUCTS[+idx].id).select('*').single();
      } else {
        resp = await supa.from(SUPABASE_SERVICE_SCHEMA.table).insert(payload).select('*').single();
      }
      if(resp.error) throw resp.error;
      alert('Salvat în baza de date!');
      // reîncarcă lista
      const { data } = await supa.from(SUPABASE_SERVICE_SCHEMA.table).select('*').order('created_at',{ascending:false});
      PRODUCTS = data || [];
      localStorage.setItem(LS_PRODUCTS, JSON.stringify(PRODUCTS));
      render();
    }catch(err){
      alert('Eroare la salvare în DB: '+err.message);
      originalSave(); // fallback local
    }
  };

  // Upload în Supabase Storage dacă s-a ales un fișier
  const fileInput = document.getElementById('fImageFile');
  if(fileInput) fileInput.addEventListener('change', async (ev)=>{
    if(!supa) return; const file = ev.target.files && ev.target.files[0]; if(!file) return;
    try{
      const path = `${Date.now()}-${file.name}`;
      const { data, error } = await supa.storage.from(SUPABASE_SERVICE_SCHEMA.bucket).upload(path, file, { upsert:false });
      if(error) throw error;
      const { data:pub } = supa.storage.from(SUPABASE_SERVICE_SCHEMA.bucket).getPublicUrl(path);
      UPLOADED_IMAGE_DATA = pub.publicUrl;
      const prev=document.getElementById('imgPreview'); prev.src=UPLOADED_IMAGE_DATA; prev.style.display='inline-block';
      document.getElementById('fImage').value='';
    }catch(err){ alert('Eroare upload imagine: '+err.message); }
  });
})();
</script>
</body>
</html>
